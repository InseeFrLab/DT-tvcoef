---
# title: "Mise en ligne du document de travail « Utilisation de modèles de régression à coefficients variant dans le temps pour la prévision conjoncturelle »"
format: 
  odt:
    fig-width: 6.3 # 16cm
    reference-doc: template.odt
echo: false
crossref:
  tbl-prefix: table
  fig-prefix: figure
  sec-prefix: section
  eq-prefix: équation
  title-delim: "&nbsp;:"
tbl-cap-location: top
fig-cap-location: top
editor: 
  markdown: 
    wrap: sentence
---

```{r}
#| include: false
#| eval: false
library(tvCoef)
library(dynlm)
library(strucchange)
library(tvReg)
library(ggplot2)
library(patchwork)
library(forecast)
library(gt)
library(ggforce)

# # colors = pal_viridis()(4),
# # colors = rev(pal_brewer("qual")(4)),
# colors = pal_hue()(4)
colors_graph <- c("#F8766D", "#7CAE00", "#00BFC4", "#C77CFF")
coef2plot <- function(x, linetype = 1, start = NULL, end = NULL,
                      colors = colors_graph){
  noms_mod <- names(x)
  linetype <- rep(linetype, length(x))
  x <- lapply(x, window, start = start, end = end, extend =TRUE)
  plot_i <- function(x, col){
    p <- autoplot(x[[1]][,col], series = noms_mod[1], linetype=linetype[1],size = 1.2) + 
      labs(y = NULL, x = NULL, title = colnames(x[[1]])[col])
    
    for (i in seq_len(length(x)-1)+1) {
      p <- p + autolayer(x[[i]][,col], series = noms_mod[i], linetype=linetype[i], size = 1.2)
    }
    p +
      theme_bw() + 
      theme(legend.title=element_blank())+
      scale_color_manual(breaks = noms_mod,
                             values = colors)
  }
  (plot_i(x, 3) + plot_i(x, 1) / plot_i(x, 2)) + 
    plot_layout(guides = 'collect') 
}

ind <- cbind(
  time(gdp) == 2020, time(gdp) == 2020.25, 
  time(gdp) == 2020.5, time(gdp) == 2020.75,
  time(gdp) == 2021.5
)
ind <- ts(apply(ind,2, as.numeric), start = start(gdp), frequency = 4)
colnames(ind) <- c(sprintf("ind2020T%i", 1:4), "ind2021T3")
data_covid <- ts.union(gdp, ind)
colnames(data_covid) <- c(colnames(gdp), colnames(ind))
# Renormalisation à 0 du climat des affaires
bc_variables <- c("bc_fr_m1", "bc_fr_m2", "bc_fr_m3")
data_covid[, bc_variables] <- data_covid[, bc_variables] - 100

reg_lin_covid <- dynlm(
  formula = growth_gdp ~ bc_fr_m1 + diff_bc_fr_m1 +
    ind2020T1 + ind2020T2 + ind2020T3 + ind2020T4 + 
    ind2021T3,
  data = window(data_covid, start = 1980)
)

reg_morc_covid <- piece_reg(
  reg_lin_covid, break_dates = 2000.5,
  # Les indicatrices ne sont pas découpées
  fixed_var = 4:8)
reg_loc_covid <- tvReg::tvLM(
  formula = growth_gdp ~ bc_fr_m1 + diff_bc_fr_m1 +
    ind2020T1 + ind2020T2 + ind2020T3 + ind2020T4 + ind2021T3,
  data = window(data_covid, start = 1980),
  # On reprend l'ancienne fenêtre
  bw = 0.748198944156928
)
ssm_covid <- ssm_lm(
  reg_lin_covid, 
  fixed_var_intercept = FALSE,
  # On fixe les coefficients des indicatrices
  # et le coefficient du climat des affaires en niveau 
  # (sinon il varie dans le temps)
  fixed_var_variables = c(c(TRUE, FALSE), rep(TRUE, 5)),
  var_intercept = 0.01,
  var_variables = c(0, 0.01, rep(0, 5))
)

coef_morc_covid <- coef(reg_morc_covid)
coef_lin_covid <- ts(matrix(coef(reg_lin_covid), nrow = 1), 
               start = start(coef_morc_covid),
               end = end(coef_morc_covid),
               frequency = frequency(coef_morc_covid))
colnames(coef_lin_covid)[1:3] <- c("Constante",
                              "Climat des affaires en niveau",
                              "Climat des affaires en différence")
coef_reg_loc_covid <- ts(coef(reg_loc_covid), start = 1980, frequency = 4)
coef_ssm_covid <- coef(ssm_covid)
options(OutDec = ",")
p <- coef2plot(
  list(
    "Rég. linéaire" = coef_lin_covid,
    "Rég. par morceaux" = coef_morc_covid,
    "Rég. locale" = coef_reg_loc_covid,
    "Coef. stochastiques\n(espace-état)" = coef_ssm_covid
  )
)
ggsave("n2p.png", p,
       width = 9.5, height = 6.5)
options(OutDec = ".")
```

**Une étude intitulée « Utilisation de modèles de régression à coefficients variant dans le temps pour la prévision conjoncturelle » va être publiée sous forme de document de travail de l'Insee.** Elle est réalisée par Alain Quartier-la-Tente.
Elle a été présentée lors d'un atelier pratique D2E le 16 mars 2023.
Tous les codes utilisés sont disponibles sur [GitHub](https://github.com/InseeFrLab/DT-tvcoef) et le package R [tvCoef](https://github.com/InseeFrLab/tvCoef) accompagne cette étude.

**Cette étude compare les principales méthodes d'estimation de régression linéaire avec coefficients variant dans le temps dans le cadre de la prévision conjoncturelle.** 
Ces méthodes se regroupent en trois catégories : les modèles de régression par morceaux, les régressions locales et les régressions avec coefficients stochastiques (estimés par une modélisation espace-état).
La première suppose l'existence d'une rupture brutale sur les coefficients à une certaine date ; les deux autres supposent que les coefficients évoluent progressivement dans le temps sans rupture brutale.
Pour simplifier l'utilisation de ces méthodes, un **package R [tvCoef](https://github.com/InseeFrLab/tvCoef) a été développé, et le document illustre précisément l'utilisation de ce package, les instructions utiles et la lecture des sorties.** En pratique, le package propose deux tests de stabilité des coefficients dans le temps, et la mise en œuvre des principales méthodes ainsi que leur comparaison.

Les différentes méthodes, ainsi que leur implémentation sous R, **sont illustrées à partir d'un exemple de prévision de la croissance du PIB français à partir du climat des affaires** France publié par l'Insee[^1].
Elles sont également comparées sur une trentaine de modèles de prévision trimestrielle.

[^1]:  Le document de travail présente les résultats d'étalonnages de la croissance trimestrielle à partir des informations du climat des affaires du premier mois du trimestre.
    Des travaux ont aussi été menés pour les étalonnages utilisant le 2ème mois ou le 3ème mois du trimestre.
    Si la précision des modèles s'accroît avec la connaissance de chaque mois, les conclusions relatives à l'apport des modèles à coefficients variables sont les mêmes.

**Même si ces méthodes permettent, par rapport à la régression linéaire, d'améliorer la qualité des prévisions, elles n'ont pas vocation à remplacer les modèles existants mais plutôt à les compléter.** **L'interprétation économique et les hypothèses sous-jacentes sont différentes entre chaque modèle : l'analyse faite de la prévision dépend donc également de la conjoncture récente.** 
La @fig-coef-covid illustre les coefficients estimés par les différentes méthodes pour la prévision de la croissance du PIB français à partir du climat des affaires France en niveau et en différence, ainsi que différentes indicatrices pour la crise du Covid-19, sur un modèle estimé entre 1980 et 2023.
La régression par morceaux suppose l'existence d'une rupture brutale des coefficients à partir de 2000T3 alors que les deux autres méthodes supposent que les coefficients évoluent de manière progressive (à une vitesse qui peut être fixée par le statisticien ou estimée directement par les algorithmes).

En termes de résultats :

-   Les diverses méthodes donnent des résultats proches pour les coefficients associés à la constante (voisine de la croissance trimestrielle moyenne sur la période) et le climat des affaires en niveau.
    Un niveau de climat 5 points plus élevé est associé à une croissance (trimestrielle) plus élevée de 0,1 % environ.

-   En revanche, les estimations, et donc les hypothèses sous-jacentes, sont différentes pour le coefficient du climat des affaires en différence.
    Si en moyenne une hausse du climat de 2,5 points sur 3 mois est associée à un surcroît de croissance de 0,1 % environ, ce coefficient apparaît très variable.
    Notamment, la régression avec coefficients stochastiques estime un impact plus faible à certaines périodes (avant 1983, entre 1995 et 1999 et après 2011) et plus fort à d'autres (notamment pendant la crise financière).

::: {#fig-coef-covid}
![](n2p.png){width="100%"}

Note : les échelles sont différentes entre les différents graphiques.
Le climat des affaires en niveau (de moyenne 100) est renormalisé à 0 afin de faciliter l'interprétation de la constante.
Source : Insee (PIB et climat des affaires France entre 1980 et 2023 téléchargés le 15 mars 2024), calculs de l'auteur.

Coefficients estimés (hors indicatrices), pour un modèle de prévision de la croissance du PIB français, par régression linéaire, régression par morceaux, régression locale et régression avec coefficients stochastiques (modélisation espace-état).
:::

**Les résultats montrent que par rapport à une régression linéaire classique, la régression avec coefficients stochastiques améliore davantage la qualité des prévisions** (erreurs de prévision plus faibles) que les autres méthodes dans la majorité des cas.
En effet, ces modèles avec coefficients stochastiques s'ajustent particulièrement bien aux données, les prévisions sont améliorées même lorsque les tests classiques concluent à la constance des coefficients.
En revanche, la régression locale dégrade généralement la qualité des prévisions par rapport à la régression linéaire dans les exercices de prévision en pseudo temps-réel, du fait des instabilités liées à l'identification des paramètres utilisés et des révisions relatives à l'estimation des coefficients.
La régression par morceaux, plus simple à mettre en œuvre, permet d'améliorer les résultats dans certains cas, mais avec des performances en général moindres que celles obtenues avec la régression avec coefficients stochastiques.
En outre, contrairement aux deux autres méthodes pour lesquelles les coefficients évoluent continûment, la régression par morceaux nécessite l'identification d'une ou plusieurs dates de rupture.

**Au total par rapport aux régressions linéaires simples usuelles, ces méthodes à coefficients variables apportent un complément intéressant**.
Elles peuvent signaler une limite à l'usage des modélisations à coefficients constants, et permettent en principe d'améliorer la précision en prévision, au prix d'une complexité accrue.
L'interprétation économique et les hypothèses sous-jacentes sont différentes entre chaque modèle, appelant à des analyses fines.
Cela milite pour une utilisation sélective en complément des outils classiques pour l'analyse des relations et des comportements à fort enjeu pour le diagnostic économique et conjoncturel.
